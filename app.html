<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>배움로그</title>
    <link rel="icon" type="image/png" href="images/Gemini_Generated_Image_d19ctrd19ctrd19c.png">
    <link rel="apple-touch-icon" href="images/Gemini_Generated_Image_d19ctrd19ctrd19c.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style_theme.css">
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;500;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="card">
        <!-- 로딩 화면 -->
        <div id="authLoadingSection" style="text-align:center; padding:40px;">
            <div class="spinner"
                style="display:inline-block; width:40px; height:40px; border:4px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite;">
            </div>
            <p style="margin-top:15px; color:var(--text-sub);">로그인 확인 중...</p>
        </div>

        <!-- 학생 온보딩 (첫 사용자) -->
        <div id="studentOnboardingSection" class="hidden">
            <h1 class="app-title">
                <img class="floating-emoji app-brand-icon" src="images/Gemini_Generated_Image_d19ctrd19ctrd19c-removebg-preview.png" alt="배움로그 아이콘">
                <span class="app-title-text">배움로그</span>
            </h1>
            <div style="display:flex; justify-content:flex-end; align-items:center; margin-bottom:20px;">
                <button onclick="logoutGoogle()"
                    style="width:auto; padding:6px 12px; font-size:0.8rem; background:#C8C1B8; color:var(--text-main); box-shadow:none;">로그아웃</button>
            </div>
            <div class="accent-box box-blue">
                <span class="box-label">👩‍🎓 학급 설정 (처음 1회만)</span>
                <p style="text-align:center; color:var(--text-sub); margin-bottom:15px; font-size:0.9rem;">
                    선생님이 알려준 학급 정보를 입력해주세요.<br>한 번만 입력하면 다음부터 자동 로그인됩니다!
                </p>
                <label>학급명</label>
                <input type="text" id="onboardClassName" placeholder="예: 부평서초6-1" required>
                <label>클래스 코드</label>
                <input type="text" id="onboardClassCode" placeholder="선생님이 알려준 코드 (예: 부평서초34)" maxlength="20" required>
                <div class="type-selector">
                    <label><input type="radio" name="onboardType" value="individual" checked> 👤 개인</label>
                    <label><input type="radio" name="onboardType" value="group"> 👥 모둠</label>
                </div>
                <label id="onboardIdLabel">나의 번호</label>
                <input type="number" id="onboardStudentNumber" placeholder="번호 입력 (예: 15)" required>
                <button type="button" id="saveOnboardBtn" onclick="saveStudentOnboarding()"
                    style="background:var(--color-blue);">설정 완료</button>
                <div id="onboardMsg" class="message"></div>
            </div>
        </div>

        <!-- 교사 온보딩 (첫 사용자) -->
        <div id="teacherOnboardingSection" class="hidden">
            <h1 class="app-title">
                <img class="floating-emoji app-brand-icon" src="images/Gemini_Generated_Image_d19ctrd19ctrd19c-removebg-preview.png" alt="배움로그 아이콘">
                <span class="app-title-text">배움로그</span>
            </h1>
            <div style="display:flex; justify-content:flex-end; align-items:center; margin-bottom:20px;">
                <button onclick="logoutGoogle()"
                    style="width:auto; padding:6px 12px; font-size:0.8rem; background:#C8C1B8; color:var(--text-main); box-shadow:none;">로그아웃</button>
            </div>
            <div class="accent-box box-violet">
                <span class="box-label">👨‍🏫 클래스 만들기 (처음 1회만)</span>
                <p style="text-align:center; color:var(--text-sub); margin-bottom:15px; font-size:0.9rem;">
                    ✨ 새 클래스를 만들어보세요!<br>한 번만 설정하면 다음부터 자동으로 접속됩니다.
                </p>
                <label>학급명 설정</label>
                <input type="text" id="newOnboardClassName" placeholder="예: 부평서초6-1" required>
                <label>클래스 코드 설정</label>
                <input type="text" id="newOnboardClassCode" placeholder="예: 부평서초34, math1" maxlength="20" required>
                <p style="font-size:0.8rem; color:var(--text-sub); margin-top:-10px; margin-bottom:15px;">
                    1~10자리, 숫자·영문·한글 조합 가능</p>
                <button type="button" id="saveTeacherOnboardBtn" onclick="saveTeacherOnboarding()"
                    style="background:var(--color-teacher);">클래스 생성하기</button>
                <div id="teacherOnboardMsg" class="message"></div>
            </div>
        </div>

        <!-- 학생 메인 (기존 사용자 / 온보딩 후) -->
        <div id="studentTab" class="hidden">
            <h1 class="app-title">
                <img class="floating-emoji app-brand-icon" src="images/Gemini_Generated_Image_d19ctrd19ctrd19c-removebg-preview.png" alt="배움로그 아이콘">
                <span class="app-title-text">배움로그</span>
            </h1>
            <div id="studentMainSection" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <span id="welcomeMsg" style="font-weight:700; color:var(--primary); font-size:1.1rem;"></span>
                    <button onclick="logoutGoogle()"
                        style="width:auto; padding:8px 15px; font-size:0.85rem; background:#C8C1B8; color:var(--text-main); box-shadow:none;">로그아웃</button>
                </div>
                <!-- 기존 탭 내비게이션 (롤백용 주석 처리) -->
                <!-- <div class="mini-tab-container">
                    <button class="mini-tab-btn active-student" onclick="switchStudentMainTab('self')">💝 스스로 배움</button>
                    <button class="mini-tab-btn" onclick="switchStudentMainTab('peer')">👥 친구로 배움</button>
                    <button class="mini-tab-btn" onclick="switchStudentMainTab('praise')">💌 칭찬 우체통</button>
                    <button class="mini-tab-btn" onclick="switchStudentMainTab('settings')">⚙️ 설정</button>
                </div> -->

                <!-- 새로운 하단 내비게이션 바 -->
                <nav class="bottom-nav">
                    <button class="nav-item active-nav" onclick="switchStudentMainTab('self')">
                        <span class="nav-icon">💝</span>
                        <span class="nav-label">스스로 배움</span>
                    </button>
                    <button class="nav-item" onclick="switchStudentMainTab('peer')">
                        <span class="nav-icon">👥</span>
                        <span class="nav-label">친구로 배움</span>
                    </button>
                    <button class="nav-item" onclick="switchStudentMainTab('praise')">
                        <span class="nav-icon">💌</span>
                        <span class="nav-label">칭찬 우체통</span>
                    </button>
                    <button class="nav-item" onclick="switchStudentMainTab('settings')">
                        <span class="nav-icon">⚙️</span>
                        <span class="nav-label">설정</span>
                    </button>
                </nav>

                <!-- 배움노트 섹션 -->
                <div id="selfEvaluationSection">
                    <!-- 성향 진단 화면 -->
                    <div id="personalityQuiz" class="hidden">
                        <div class="accent-box box-violet">
                            <span class="box-label">🧠 나의 성장 파트너 찾기</span>
                            <p style="text-align:center; color:var(--text-sub); line-height:1.6; margin-bottom:20px;">
                                8개의 질문으로, 나를 더 잘 성장시키는<br>
                                조언 스타일을 찾아요!
                            </p>
                            <div id="quizContent"></div>
                            <button id="submitQuizBtn" class="hidden" onclick="submitPersonalityQuiz()"
                                style="background:var(--color-teacher); margin-top:20px;">분석 완료</button>
                        </div>
                    </div>

                    <!-- 성향 결과 화면 -->
                    <div id="personalityResult" class="hidden">
                        <div class="accent-box" id="personalityCard">
                            <div style="text-align:center; margin-bottom:20px;">
                                <div id="personalityIcon" style="font-size:4rem; margin-bottom:10px;"></div>
                                <h3 id="personalityTitle" style="color:var(--color-teacher); margin:0;"></h3>
                                <p id="personalityDesc"
                                    style="color:var(--text-sub); margin-top:10px; line-height:1.6;">
                                </p>
                            </div>
                            <div id="allPersonalityTypes" style="margin-top:18px;"></div>
                            <div
                                style="display:flex; gap:10px; justify-content:center; margin-top:18px; flex-wrap:wrap;">
                                <button onclick="confirmPersonalityResult()"
                                    style="background:linear-gradient(135deg, #10b981, #059669); color:white; font-size:0.95rem; padding:12px 32px; border-radius:50px; border:none; font-family:'Jua',sans-serif; cursor:pointer;">확인하고
                                    시작하기</button>
                                <button onclick="resetPersonalityFromSettings()"
                                    style="background:var(--border); color:var(--text-main); font-size:0.85rem; padding:10px 20px; border-radius:50px; border:none; font-family:'Jua',sans-serif; cursor:pointer;">다시
                                    진단하기</button>
                            </div>
                        </div>
                    </div>

                    <!-- 배움노트 메뉴 -->
                    <div id="selfEvaluationMenu" class="hidden">
                        <div class="sub-tab-container">
                            <button class="sub-tab-btn active" onclick="switchSelfTab('daily')">📝 배움 노트</button>
                            <button class="sub-tab-btn" onclick="switchSelfTab('project')">🌟 프로젝트 돌아보기</button>
                            <button class="sub-tab-btn" onclick="switchSelfTab('dashboard')">📊 결과보기</button>
                        </div>
                        <div class="accent-box box-violet class-tone-section" style="margin-top: 15px; margin-bottom: 20px;">
                            <label>조회/기록 날짜</label>
                            <input type="date" id="selfDate" class="class-tone-input" required
                                style="width:100%; font-family:'Jua', sans-serif !important; font-size:1.05rem;"
                                onchange="syncAllDates(this.value); loadDailyReflection()">
                        </div>

                        <!-- 성장 일기 탭 -->
                        <div id="dailyReflectionTab">
                            <div class="accent-box box-blue">
                                <span class="box-label">📚 오늘의 배움</span>
                                <label>오늘 배운 것이나 느낀 점</label>
                                <div class="guide-buttons"
                                    style="display:flex; gap:6px; margin-bottom:8px; overflow-x: auto; white-space: nowrap; padding-bottom: 4px; flex-wrap: nowrap; padding: 2px;">
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('\uC624\uB298 \uBC30\uC6B4 \uB0B4\uC6A9: \n', 'learningText')">&#x1F4D8; &#xC624;&#xB298; &#xBC30;&#xC6B4; &#xB0B4;&#xC6A9;</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('\uB0B4\uAC00 \uC798\uD55C \uC810: \n', 'learningText')">&#x2705; &#xB0B4;&#xAC00; &#xC798;&#xD55C; &#xC810;</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('\uC5B4\uB824\uC6E0\uB358 \uC810: \n', 'learningText')">&#x1F635; &#xC5B4;&#xB824;&#xC6E0;&#xB358; &#xC810;</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('\uC774\uD574/\uD574\uACB0 \uBC29\uBC95: \n', 'learningText')">&#x1F4A1; &#xC774;&#xD574;/&#xD574;&#xACB0; &#xBC29;&#xBC95;</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('\uC544\uC9C1 \uD5F7\uAC08\uB9AC\uB294 \uC810: \n', 'learningText')">&#x2753; &#xC544;&#xC9C1; &#xD5F7;&#xAC08;&#xB9AC;&#xB294; &#xC810;</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('\uC77C\uC0C1\uC5D0 \uC801\uC6A9\uD574\uBCFC \uC810: \n', 'learningText')">&#x1F331; &#xC77C;&#xC0C1;&#xC5D0; &#xC801;&#xC6A9;&#xD574;&#xBCFC; &#xC810;</button>

                                </div>
                                <textarea id="learningText"
                                    placeholder="예: 오늘 수학 시간에 분수의 나눗셈을 배웠는데 처음엔 어려웠지만 연습하니까 이해됐다"
                                    style="min-height:176px; margin-bottom:10px;"></textarea>
                                <label style="margin-bottom:8px;">과목/활동 태그 (여러 개 선택 가능)</label>
                                <div class="subject-tags"
                                    style="display:flex; gap:6px; margin-bottom:5px; margin-top:10px; flex-wrap: wrap;">
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('국어')">📖
                                        국어</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('수학')">🔢
                                        수학</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('사회')">🌍
                                        사회</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('과학')">🔬
                                        과학</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('영어')">🔤
                                        영어</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('음악')">🎵
                                        음악</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('미술')">🎨
                                        미술</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('체육')">⚽
                                        체육</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('도덕')">💛
                                        도덕</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('실과')">🔧
                                        실과</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('토론')">💬
                                        토론</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('발표')">🎤
                                        발표</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('모둠활동')">👥
                                        모둠활동</button>
                                    <button type="button" class="subject-tag-btn" onclick="toggleSubjectTag('기타')">✨
                                        기타</button>
                                </div>
                            </div>

                            <button type="button" id="saveDailyBtn" onclick="submitDailyReflection()"
                                style="background:var(--color-eval);">저장하기</button>
                            <div id="dailyMsg" class="message"></div>
                            <div id="aiFeedbackSection" class="hidden" style="margin-top:20px;">
                                <div class="accent-box"
                                    style="border-left-color:var(--color-teacher); background:linear-gradient(135deg, #f5f0ff 0%, #ede7ff 100%);">
                                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                                        <span style="font-size:1.8rem;">🤖</span>
                                        <span style="font-weight:700; color:var(--color-teacher); font-size:1rem;">AI 맞춤
                                            피드백</span>
                                    </div>
                                    <div id="aiFeedbackText"
                                        style="color:var(--text-main); line-height:1.7; font-size:0.95rem;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 성장 대시보드 탭 -->
                        <div id="dashboardTab" class="hidden">
                            <!-- 연속 기록 스트릭 & 뱃지 -->
                            <div id="streakBadgeArea" class="accent-box" style="text-align:center;">
                                <div id="streakDisplay" style="font-size:1.3rem; font-weight:700; margin-bottom:10px;">
                                </div>
                                <div id="badgeContainer"
                                    style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;"></div>
                            </div>


                            <!-- 배움 키워드 워드클라우드 -->
                            <div class="accent-box box-blue">
                                <span class="box-label">💡 나의 배움 키워드</span>
                                <p style="font-size:0.85rem; color:var(--text-sub); margin-bottom:15px;">내가 자주 쓴 단어일수록
                                    크게 표시돼요!</p>
                                <div id="learningWordCloud" class="word-cloud">
                                    <div class="empty-state"><span class="empty-icon">📝</span>
                                        <div class="empty-desc">기록이 쌓이면 키워드가 나타나요!</div>
                                    </div>
                                </div>
                            </div>
                            <!-- 과목/활동 분포 -->
                            <div class="accent-box box-amber">
                                <span class="box-label">📊 과목별 기록 횟수</span>
                                <div id="subjectChart" class="subject-chart">
                                    <div class="empty-state"><span class="empty-icon">📚</span>
                                        <div class="empty-desc">과목 태그를 선택하면 통계가 나타나요!</div>
                                    </div>
                                </div>
                            </div>
                            <!-- 성장 타임라인 -->
                            <div class="accent-box box-teal">
                                <span class="box-label">🌱 성장 타임라인</span>
                                <div id="growthTimeline" class="growth-timeline">
                                    <div class="empty-state"><span class="empty-icon">🌱</span>
                                        <div class="empty-desc">기록이 쌓이면 성장 과정이 보여요!</div>
                                    </div>
                                </div>
                            </div>
                            <!-- 주간/월간 요약 -->
                            <div class="accent-box"
                                style="border-left-color: var(--color-teacher); background:linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);">
                                <span class="box-label">📋 요약 리포트</span>
                                <div style="display:flex; gap:10px; margin-bottom:15px;">
                                    <button type="button" class="summary-period-btn active"
                                        onclick="generateSummaryReport('week')" style="flex:1;">📅 이번 주 요약</button>
                                    <button type="button" class="summary-period-btn"
                                        onclick="generateSummaryReport('month')" style="flex:1;">📆 이번 달 요약</button>
                                </div>
                                <div id="summaryReportArea">
                                    <div class="empty-state"><span class="empty-icon">📋</span>
                                        <div class="empty-desc">버튼을 눌러 AI 요약을 받아보세요!</div>
                                    </div>
                                </div>
                            </div>
                            <!-- AI 성장 리포트 -->
                            <div class="accent-box"
                                style="border-left-color: var(--text-main); background:var(--bg-body);">
                                <span class="box-label" style="color:var(--text-main);">⭐ AI 성장 리포트</span>
                                <p style="font-size:0.85rem; color:var(--text-sub); margin-bottom:15px;">나의 전체 기록을 분석해서
                                    성장 포인트를 알려줘요!</p>
                                <button type="button" onclick="generateGrowthReport()" id="growthReportBtn"
                                    style="background:var(--text-main); margin-bottom:15px;">🤖
                                    AI 성장 리포트 받기</button>
                                <div id="growthReportArea">
                                    <div class="empty-state"><span class="empty-icon">⭐</span>
                                        <div class="empty-desc">버튼을 눌러 나만의 성장 리포트를 받아보세요!</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 프로젝트 탭 -->
                        <div id="projectReflectionTab" class="hidden">
                            <div class="accent-box box-amber">
                                <span class="box-label">🌟 프로젝트 돌아보기</span>
                                <label>프로젝트 이름</label>
                                <input type="text" id="projectName" placeholder="예: 세계 여행 가이드북 만들기">

                                <div class="guide-buttons"
                                    style="display:flex; gap:6px; margin-bottom:8px; overflow-x: auto; white-space: nowrap; padding-bottom: 4px; flex-wrap: nowrap; padding: 2px;">
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('👍 잘된 점: \n', 'projectComment')">👍 잘된 점</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('🤔 아쉬운 점/어려웠던 점: \n', 'projectComment')">🤔 아쉬운
                                        점</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('✨ 인상적인 순간/배운 점: \n', 'projectComment')">✨
                                        인상/배움</button>

                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('💪 다음 도전: \n', 'projectComment')">💪 다음 도전</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('🎯 다음을 위한 팁: \n', 'projectComment')">🎯 다음 팁</button>
                                </div>
                                <textarea id="projectComment" placeholder="이번 프로젝트에서 느낀 점이나 배운 것"
                                    style="min-height:176px; margin-bottom:10px;"></textarea>
                            </div>
                            <button type="button" id="submitProjectBtn" onclick="submitProjectReflection()"
                                style="background:var(--color-result);">제출</button>
                            <div id="projectMsg" class="message"></div>
                            <div id="projectAIAnalysis" class="hidden ai-encouragement">
                                <div class="ai-icon">🤖</div>
                                <div id="projectAIText"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 친구로 배움 섹션 -->
                <div id="peerEvaluationSection" class="hidden">
                    <div class="sub-tab-container">
                        <button class="sub-tab-btn active" onclick="switchPeerTab('submit')">📝 평가하기</button>
                        <button class="sub-tab-btn" onclick="switchPeerTab('result')">📊 결과보기</button>
                    </div>
                    <div id="studentSubmitTab">
                        <form id="reviewForm">
                            <label>평가 날짜</label>
                            <input type="date" id="reviewDate" class="class-tone-input" required
                                style="width:100%; font-family:'Jua', sans-serif !important; font-size:1.05rem;"
                                onchange="syncAllDates(this.value)">
                            <div class="type-selector">
                                <label><input type="radio" name="evalTypeDisplay" value="individual"
                                        onchange="switchTypeAndLogout('individual')"> 👤 개인평가</label>
                                <label><input type="radio" name="evalTypeDisplay" value="group"
                                        onchange="switchTypeAndLogout('group')"> 👥 모둠평가</label>
                            </div>
                            <div class="accent-box box-blue">
                                <span class="box-label">🎯 학습 목표 및 평가 과제</span>
                                <div id="objectiveArea" style="margin-bottom:15px;">
                                    <div
                                        style="font-weight:700; color:var(--color-blue); font-size:0.85rem; margin-bottom:5px;">
                                        학습 목표</div>
                                    <div id="objectiveText" style="color:var(--text-main);">등록된 학습목표가 없습니다.</div>
                                </div>
                                <div id="taskArea" style="border-top:1px dashed var(--border); padding-top:15px;">
                                    <div
                                        style="font-weight:700; color:var(--color-blue); font-size:0.85rem; margin-bottom:5px;">
                                        평가 과제</div>
                                    <div id="taskText" style="color:var(--text-main);">등록된 평가과제가 없습니다.</div>
                                </div>
                            </div>
                            <div class="accent-box box-teal">
                                <span class="box-label">📝 평가 정보 입력</span>
                                <label id="submitReviewerLabel">나의 번호</label>
                                <input type="text" id="reviewerId" readonly
                                    style="background:var(--border-light); cursor:not-allowed;">
                                <label id="submitTargetLabel">평가 대상 선택</label>
                                <div id="progressArea" style="margin-bottom:15px;">
                                    <div class="progress-text" id="progressText">평가 진행: 0 / 0명</div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill" id="progressBar" style="width:0%"></div>
                                    </div>
                                </div>
                                <div id="targetGrid" class="target-grid"></div>
                                <input type="hidden" id="targetId">
                            </div>
                            <div id="ratingSection" class="accent-box box-amber hidden">
                                <span class="box-label">평가 기준</span>
                                <div id="ratingItems"></div>
                            </div>
                            <div class="accent-box box-green">
                                <span class="box-label">💬 서로의 발전을 돕는 피드백</span>
                                <div class="feedback-templates"
                                    style="display:flex; gap:6px; margin-bottom:8px; overflow-x: auto; white-space: nowrap; padding-bottom: 4px; padding: 2px;">
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('👍 잘한 점: \n')">👍
                                        잘한 점</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('💡 이렇게 하면 더 좋을 것 같아: \n')">💡 개선 제안</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('✨ 특히 인상적이었던 부분은 \n')">✨ 인상적인 부분</button>
                                    <button type="button" class="template-btn"
                                        onclick="insertTemplate('💪 다음에는 이런 점을 시도해보면 좋겠어: \n')">💪 다음 도전</button>
                                </div>
                                <textarea id="reviewContent"
                                    placeholder="👍 잘한 점:&#10;💡 이렇게 하면 더 좋아질 것 같아:&#10;✨ 특히 인상적이었던 부분은&#10;💪 다음에는 이런 점을 시도해보면 좋겠어:" required
                                    minlength="100" oninput="updateCharCount()"
                                    style="margin-bottom:5px; min-height:160px;"></textarea>
                                <div id="charCount" style="text-align:right; font-size:0.85rem; color:var(--text-sub);">
                                    0자 /
                                    최소 100자</div>
                            </div>
                            <button type="submit" id="submitBtn" class="not-ready">평가 제출하기</button>
                        </form>
                        <div id="submitMsg" class="message"></div>
                    </div>
                    <div id="studentResultTab" class="hidden">
                        <div class="type-selector" style="margin-bottom:20px;">
                            <label><input type="radio" name="resultEvalTypeDisplay" value="individual"
                                    onchange="switchTypeAndLogout('individual')"> 👤 개인평가</label>
                            <label><input type="radio" name="resultEvalTypeDisplay" value="group"
                                    onchange="switchTypeAndLogout('group')"> 👥 모둠평가</label>
                        </div>
                        <div class="accent-box box-amber class-tone-section">
                            <span class="box-label">결과 조회</span>
                            <label>조회 날짜</label>
                            <input type="date" id="viewDate" class="class-tone-input" required
                                style="width:100%; font-family:'Jua', sans-serif !important; font-size:1.05rem;"
                                onchange="syncAllDates(this.value)">
                            <button type="button" id="viewResultBtn" onclick="viewMyResult()">내 결과 확인하기</button>
                        </div>
                        <div id="viewMsg" class="message"></div>
                        <div id="resultArea" class="hidden" style="margin-top:30px;">
                            <div id="statsSummary" class="stats-summary"></div>
                            <div id="chartContainer" class="chart-container hidden">
                                <h4>📊 항목별 점수 현황</h4>
                                <div id="barChart" class="bar-chart"></div>
                            </div>
                            <div class="accent-box box-violet">
                                <span class="box-label" style="margin-bottom:8px;">🤖 AI 요약 리포트</span>
                                <div id="mySummary" style="color:var(--text-main);"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 우체통 섹션 -->
                <div id="praiseSection" class="hidden">
                    <div class="sub-tab-container" style="margin-bottom:20px;">
                        <button class="sub-tab-btn active" onclick="switchPraiseTab('send')">💌 칭찬 보내기</button>
                        <button class="sub-tab-btn" onclick="switchPraiseTab('received')">📬 받은 칭찬</button>
                        <button class="sub-tab-btn" onclick="switchPraiseTab('teacher')">💌 선생님께 편지</button>
                    </div>
                    <div id="praiseSendTab">
                        <div class="accent-box class-tone-section">
                            <span class="box-label">💌 친구에게 칭찬 보내기</span>
                            <label>받는 친구 번호</label>
                            <div id="praiseTargetGrid" class="target-grid" style="margin-bottom:15px;"></div>
                            <input type="hidden" id="praiseTargetId">
                            <div class="type-selector" style="margin-bottom:10px;">
                                <label><input type="radio" name="praiseAnon" value="anonymous" checked> 🎭 익명</label>
                                <label><input type="radio" name="praiseAnon" value="named"> 😊 이름 밝히기</label>
                            </div>
                            <textarea id="praiseContent" placeholder="친구에게 전하고 싶은 칭찬이나 감사의 말을 써주세요! (최소 10자)"
                                minlength="10" style="margin-bottom:5px;" oninput="updatePraiseCharCount()"></textarea>
                            <div id="praiseCharCount"
                                style="text-align:right; font-size:0.85rem; color:var(--text-sub);">0자 / 최소 10자</div>
                            <button type="button" id="praiseSendBtn" onclick="sendPraise()">칭찬 보내기 💝</button>
                            <div id="praiseMsg" class="message"></div>
                        </div>
                    </div>
                    <div id="praiseReceivedTab" class="hidden">
                        <div class="accent-box box-violet">
                            <span class="box-label">📬 나에게 온 칭찬</span>
                            <div id="receivedPraiseList">
                                <div class="empty-state"><span class="empty-icon">💌</span>
                                    <div class="empty-title">아직 받은 칭찬이 없어요</div>
                                    <div class="empty-desc">친구들의 칭찬이 도착하면<br>여기에 표시됩니다!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 선생님께 편지 탭 -->
                    <div id="teacherMessageTab" class="hidden">
                        <div class="accent-box box-teal" id="teacherMessageBox" style="margin-top:0;">
                            <span class="box-label">💬 선생님께 전하고 싶은 말</span>
                            <div class="message-mode-selector">
                                <button type="button" class="mode-btn" id="anonymousBtn"
                                    onclick="toggleMessageMode('anonymous')">
                                    익명으로
                                </button>
                                <button type="button" class="mode-btn" id="namedBtn"
                                    onclick="toggleMessageMode('named')">
                                    이름 밝히고
                                </button>
                            </div>
                            <div id="messageInputArea" class="hidden" style="margin-top:15px;">
                                <div id="messageModeBadge" style="padding:8px; background:var(--bg-soft); border-radius:8px;
                                text-align:center; font-size:0.85rem; color:var(--text-sub); margin-bottom:10px;">
                                </div>
                                <textarea id="teacherMessage" placeholder="선생님께 하고 싶은 말을 자유롭게 써보세요"
                                    style="min-height:120px; margin-bottom:12px;"></textarea>
                                <div style="display:flex; justify-content:space-between; align-items:center;">

                                    <button type="button" id="sendTeacherMsgBtn" onclick="submitTeacherMessageOnly()"
                                        style="background:var(--color-teacher); width:auto; padding:10px 25px; margin:0;">보내기</button>
                                </div>
                                <div id="teacherMsgResult" class="message"></div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 학생 설정 섹션 -->
                <div id="studentSettingsSection" class="hidden">
                    <!-- 박스 1: 나의 학급 정보 -->
                    <div class="accent-box" style="margin-bottom:15px;">
                        <span class="box-label">📚 나의 학급 정보</span>
                        <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
                            <div class="student-class-info-row"
                                style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px; background:var(--bg-body); border-radius:12px;">
                                <span style="color:var(--text-sub); font-size:0.9rem;">학급명</span>
                                <span id="settingsClassName"
                                    style="font-weight:700; color:var(--text-main); font-size:0.95rem;">-</span>
                            </div>
                            <div class="student-class-info-row"
                                style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px; background:var(--bg-body); border-radius:12px;">
                                <span style="color:var(--text-sub); font-size:0.9rem;">학급 코드</span>
                                <span id="settingsClassCode"
                                    style="font-weight:700; color:var(--text-main); font-size:0.95rem;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 박스 2: 나의 성장 파트너 (성향 진단) -->
                    <div class="accent-box" style="margin-bottom:15px;">
                        <span class="box-label">🧠 나의 성장 파트너</span>
                        <div id="settingsPersonalityArea" style="margin-top:10px;">
                            <p style="color:var(--text-sub); text-align:center;">로딩 중...</p>
                        </div>
                    </div>

                    <!-- 박스 3: 학급 변경 -->
                    <div class="accent-box class-tone-section" style="border-color:#fca5a5;">
                        <span class="box-label">🔄 학급 변경</span>
                        <p style="font-size:0.8rem; color:#ef4444; margin-bottom:12px; line-height:1.5;">
                            ⚠️ 학급을 변경하면 기존 데이터(일기, 평가, 칭찬 등)가 <strong>모두 삭제</strong>됩니다.
                        </p>
                        <div style="margin-bottom:12px;">
                            <label>새 학급명</label>
                            <input type="text" id="newClassNameInput" placeholder="이동할 학급명 입력 (예: 부평서초6-1)"
                                style="font-family:'Jua', sans-serif !important;">
                        </div>
                        <div style="margin-bottom:12px;">
                            <label>새 학급 코드</label>
                            <input type="text" id="newClassCodeInput" placeholder="이동할 학급 코드 입력"
                                style="font-family:'Jua', sans-serif !important;">
                        </div>
                        <button type="button" onclick="changeClassAndReset()"
                            style="background:#ef4444; color:white;">학급 변경하기</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- 교사 메인 (기존 사용자 / 온보딩 후) -->
        <div id="teacherTab" class="hidden">
            <h1 class="app-title">
                <img class="floating-emoji app-brand-icon" src="images/Gemini_Generated_Image_d19ctrd19ctrd19c-removebg-preview.png" alt="배움로그 아이콘">
                <span class="app-title-text">배움로그</span>
            </h1>
            <div id="teacherMain" class="hidden">
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:15px;">
                    <button onclick="logoutGoogle()"
                        style="width:auto; padding:8px 20px; background:#C8C1B8; color:var(--text-main); box-shadow:none; font-size:0.85rem;">로그아웃</button>
                </div>
                <!-- 새로운 하단 내비게이션 바 (교사용) -->
                <nav class="bottom-nav" style="margin-bottom: 20px; border-radius: 20px !important;">
                    <button class="nav-item active-nav" onclick="switchMiniTab('diary')">
                        <span class="nav-icon">💝</span>
                        <span class="nav-label">스스로 배움</span>
                    </button>
                    <button class="nav-item" onclick="switchMiniTab('review')">
                        <span class="nav-icon">👥</span>
                        <span class="nav-label">친구로 배움</span>
                    </button>
                    <button class="nav-item" onclick="switchMiniTab('praise')">
                        <span class="nav-icon">💌</span>
                        <span class="nav-label">칭찬 우체통</span>
                    </button>
                    <button class="nav-item" onclick="switchMiniTab('settings')">
                        <span class="nav-icon">👤</span>
                        <span class="nav-label">학급 관리</span>
                    </button>
                </nav>
                <!-- 친구로 배움 하위 탭 -->
                <div id="reviewSubTabArea" class="hidden">
                    <div class="sub-tab-container" style="margin-bottom:15px;">
                        <button class="sub-tab-btn active" onclick="switchReviewSubTab('ranking')">📊 전체 현황</button>
                        <button class="sub-tab-btn" onclick="switchReviewSubTab('student')">👤 개별 현황</button>
                        <button class="sub-tab-btn" onclick="switchReviewSubTab('criteria')">📅 기준 설정</button>
                    </div>
                </div>
                <div id="rankStudentArea" class="accent-box box-violet" style="padding:20px; margin-top:20px;">
                    <div class="stats-filter-container"
                        style="display:flex; flex-wrap:wrap; gap:15px; align-items:flex-end;">
                        <div style="width:auto; min-width:150px;">
                            <label style="display:block; margin-bottom:8px;">📅 조회 날짜</label>
                            <input type="date" id="teacherDate" class="class-tone-input" required
                                style="width:100%; font-family:'Jua', sans-serif !important; font-size:1.05rem;"
                                onchange="syncAllDates(this.value); loadTeacherData()">
                        </div>
                        <div class="type-selector"
                            style="display:flex; gap:0; align-items:center;">
                            <label
                                style="cursor:pointer; display:flex; align-items:center; gap:5px; font-family:'Jua', sans-serif; font-size:1rem;">
                                <input type="radio" name="teacherEvalType" value="individual" checked
                                    onchange="loadTeacherData()"> 👤 개인</label>
                            <label
                                style="cursor:pointer; display:flex; align-items:center; gap:5px; font-family:'Jua', sans-serif; font-size:1rem;">
                                <input type="radio" name="teacherEvalType" value="group" onchange="loadTeacherData()">
                                👥
                                모둠</label>
                        </div>
                    </div>
                </div>
                <div id="rankingMiniTab">
                    <div id="teacherDashboard" class="stats-summary" style="margin-bottom:20px;"></div>
                    <h3>친구로 배움 현황 (내림차순)</h3>
                    <div class="ranking-table-wrapper" style="overflow-x:auto;">
                        <div id="rankingTable"></div>
                    </div>
                </div>
                <div id="studentMiniTab" class="hidden">
                    <h3>대상 번호 선택</h3>
                    <div id="studentSelector" class="student-selector"></div>
                    <div id="studentReviews"></div>
                </div>
                <div id="diaryMiniTab" class="hidden">
                    <div class="sub-tab-container" style="margin-bottom:15px;">
                        <button type="button" class="sub-tab-btn active" onclick="switchTeacherDiarySubTab(&quot;overview&quot;)">📊 참여현황</button>
                        <button type="button" class="sub-tab-btn" onclick="switchTeacherDiarySubTab(&quot;student&quot;)">📝 학생노트</button>
                        <button type="button" class="sub-tab-btn" onclick="switchTeacherDiarySubTab(&quot;comment&quot;)">🧑‍🏫 교과세특</button>
                    </div>

                    <div id="teacherDiaryOverviewTab">
                    <div class="accent-box box-violet">
                        <span class="box-label">📊 배움노트 참여 현황</span>
                        <div style="margin-top:12px; margin-bottom:10px;">
                            <label style="display:block; margin-bottom:6px;">📅 조회 날짜</label>
                            <input type="date" id="diaryViewDate" class="class-tone-input"
                                style="width:100%; font-family:'Jua', sans-serif !important; font-size:1.05rem;"
                                onchange="loadTeacherDiaryData()">
                        </div>
                        <div class="stats-summary" style="margin-top:15px;">
                            <div class="stat-card">
                                <span class="stat-number" id="totalReflections">0</span>
                                <span class="stat-label">총 작성 수</span>
                            </div>
                            <div class="stat-card blue">
                                <span class="stat-number" id="todayReflections">0</span>
                                <span class="stat-label">선택 날짜 작성</span>
                            </div>
                        </div>
                        <div style="margin-top:14px; padding-top:12px; border-top:1px dashed rgba(0,0,0,0.12);">
                            <span class="box-label" style="display:inline-block; margin:0 0 8px 0;">🧾 배움노트 제출 확인</span>
                            <div style="font-size:0.82rem; color:var(--text-sub); margin-top:6px; margin-bottom:10px;">
                                초록: 제출 완료 / 빨강: 미제출
                            </div>
                            <div id="diaryCompletionSummary"
                                style="font-size:0.9rem; color:var(--text-main); margin-bottom:10px;"></div>
                            <div id="diaryCompletionList"
                                style="display:grid; grid-template-columns:repeat(auto-fill, minmax(92px, 1fr)); gap:8px;"></div>
                        </div>
                    </div>
                    </div>

                    <div id="teacherDiaryStudentTab" class="hidden">
                    <div class="accent-box box-teal">
                        <span class="box-label">👤 학생별 배움노트</span>
                        <div id="diaryStudentDetail" style="margin-top:12px;">
                            <div class="empty-state">
                                <span class="empty-icon">📝</span>
                                <div class="empty-desc">학생 번호를 누르면 해당 학생이 오늘 쓴 배움노트를 볼 수 있습니다.</div>
                            </div>
                        </div>
                    </div>
                    <div id="emotionAlertArea" class="accent-box box-violet hidden">
                        <span class="box-label">🚨 수업 개선에 도움이 되는 어려움</span>
                        <p style="font-size:0.82rem; color:var(--text-sub); margin-bottom:10px;">
                            선택 날짜의 배움노트에서 <strong>아직 해결되지 않은 어려움</strong>만 뽑아 보여줍니다. (클릭하면 해당 학생 노트로 이동)
                        </p>
                        <div id="emotionAlertList"></div>
                    </div>

                    <!-- 교과세특(평어) 생성: 배움노트 기반 -->
                    </div>

                    <div id="teacherDiaryCommentTab" class="hidden">
                    <div id="teacherSubjectCommentSection" class="accent-box box-blue" style="margin-top:18px;">
                        <span class="box-label">🧑‍🏫 배움노트 기반 교과세특 (평어) 생성</span>
                        <p style="font-size:0.82rem; color:var(--text-sub); margin-top:8px; margin-bottom:12px;">
                            학생이 한 학기 동안 쓴 배움노트를 근거로, 생활기록부 속 교과 세부 특기 사항 문장을 생성합니다.
                        </p>

                        <div class="teacher-subject-comment-grid">
                            <div>
                                <label style="font-size:0.8rem;">현재 선택 학생</label>
                                <div id="teacherSubjectCommentStudent" class="teacher-subject-comment-pill">미선택</div>
                            </div>
                            <div>
                                <label style="font-size:0.8rem;">학교급</label>
                                <select id="teacherSubjectCommentSchoolLevel" class="class-tone-input" style="margin-bottom:0;">
                                    <option value="">선택하세요</option>
                                    <option value="초">초</option>
                                    <option value="중">중</option>
                                    <option value="고">고</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.8rem;">학기</label>
                                <div class="teacher-subject-comment-seg">
                                    <button type="button" id="teacherSubjectCommentSemester1" class="seg-btn active" onclick="setTeacherSubjectCommentSemester(1)">1학기</button>
                                    <button type="button" id="teacherSubjectCommentSemester2" class="seg-btn" onclick="setTeacherSubjectCommentSemester(2)">2학기</button>
                                </div>
                            </div>
                            <div>
                                <label style="font-size:0.8rem;">기간 시작일</label>
                                <input type="date" id="teacherSubjectCommentStart" class="class-tone-input" style="margin-bottom:0;">
                            </div>
                            <div>
                                <label style="font-size:0.8rem;">기간 종료일</label>
                                <input type="date" id="teacherSubjectCommentEnd" class="class-tone-input" style="margin-bottom:0;">
                            </div>
                        </div>

                        <div style="margin-top:12px;">
                            <label style="font-size:0.8rem; display:block; margin-bottom:8px;">과목 태그 (1개 선택)</label>
                            <div id="teacherSubjectCommentSubjectTags" class="subject-tags"></div>
                        </div>

                        <div class="teacher-subject-comment-actions">
                            <button type="button" id="teacherSubjectCommentGenerateBtn" onclick="generateTeacherSubjectComment(false)" style="background:var(--color-teacher);">생성하기</button>
                            <button type="button" id="teacherSubjectCommentRegenerateBtn" onclick="generateTeacherSubjectComment(true)" style="background:var(--color-blue);">재생성</button>
                            <button type="button" id="teacherSubjectCommentCopyBtn" onclick="copyTeacherSubjectComment()" style="background:var(--border); color:var(--text-main);">복사</button>
                            <button type="button" id="teacherSubjectCommentSaveBtn" onclick="saveTeacherSubjectComment(this)" style="background:var(--color-result);">저장</button>
                            <button type="button" id="teacherSubjectCommentExportBtn" onclick="openTeacherSubjectCommentExportModal()" style="background:linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);">.xlsx 다운로드</button>
                        </div>

                        <div class="teacher-subject-comment-meta">
                            <div>배움노트: <strong id="teacherSubjectCommentNoteCount">-</strong>건</div>
                            <div id="teacherSubjectCommentStatus" class="teacher-subject-comment-status"></div>
                        </div>

                        <div id="teacherSubjectCommentResultWrap" class="teacher-subject-comment-result-wrap">
                            <div id="teacherSubjectCommentEmpty" class="empty-state" style="margin:0;">
                                <span class="empty-icon">📄</span>
                                <div class="empty-title">설정 후 생성해 보세요</div>
                                <div class="empty-desc">학생/학기/기간/과목/학교급을 선택한 후 생성하기를 눌러주세요.</div>
                            </div>
                            <pre id="teacherSubjectCommentResult" class="teacher-subject-comment-result hidden"></pre>
                            <div id="teacherSubjectCommentError" class="message error" style="display:none;"></div>
                            <div id="teacherSubjectCommentRetry" class="hidden" style="margin-top:10px;">
                                <button type="button" onclick="generateTeacherSubjectComment(true)" style="background:var(--color-blue); width:100%;">다시 시도</button>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div id="praiseMiniTab" class="hidden">
                    <div class="sub-tab-container" style="margin-bottom:12px;">
                        <button id="teacherPraiseManageBtn" class="sub-tab-btn active"
                            onclick="switchTeacherPraiseSubTab('praise')">칭찬 관리</button>
                        <button id="teacherLetterManageBtn" class="sub-tab-btn"
                            onclick="switchTeacherPraiseSubTab('letter')">편지 관리</button>
                    </div>
                    <div id="teacherPraiseManagePanel">
                    <!-- 자동 승인 설정 -->
                    <div class="accent-box praise-approval-card"
                        style="margin-bottom:15px; padding:15px; display:flex; justify-content:space-between; align-items:center; border-color:var(--color-teacher);">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:1.2rem;">✨</span>
                            <div>
                                <div style="font-weight:700; color:var(--text-main); font-size:0.95rem;">칭찬 자동 승인 모드
                                </div>
                                <div style="font-size:0.75rem; color:var(--text-sub);">활성화하면 학생들의 칭찬이 대기 없이 즉시
                                    전달됩니다.
                                </div>
                            </div>
                        </div>
                        <label class="switch-container">
                            <input type="checkbox" id="autoApproveToggle" onchange="toggleAutoApprovePraise(this)">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <!-- 통계 요약 -->
                    <div id="praiseStatsArea" class="praise-stats-container"
                        style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                        <div class="stat-card"
                            style="flex:1; min-width:100px; text-align:center; padding:14px; background:rgba(99,102,241,0.10); border-radius:12px; border:1px solid rgba(99,102,241,0.20);">
                            <div style="font-size:1.5rem; font-weight:700; color:var(--color-teacher);"
                                id="praiseTotalCount">-
                            </div>
                            <div style="font-size:0.78rem; color:var(--text-sub);">전체 칭찬</div>
                        </div>
                        <div class="stat-card"
                            style="flex:1; min-width:100px; text-align:center; padding:14px; background:rgba(255,165,0,0.1); border-radius:12px; border:1px solid rgba(255,165,0,0.2);">
                            <div style="font-size:1.5rem; font-weight:700; color:#e67e00;" id="praisePendingCount">-
                            </div>
                            <div style="font-size:0.78rem; color:var(--text-sub);">대기 중</div>
                        </div>
                        <div class="stat-card"
                            style="flex:1; min-width:100px; text-align:center; padding:14px; background:rgba(76,175,80,0.1); border-radius:12px; border:1px solid rgba(76,175,80,0.2);">
                            <div style="font-size:1.5rem; font-weight:700; color:#388e3c;" id="praiseApprovedCount">
                                -
                            </div>
                            <div style="font-size:0.78rem; color:var(--text-sub);">승인 완료</div>
                        </div>
                    </div>
                    <!-- 대기 중인 칭찬 -->
                    <div id="diaryParticipationCard" class="accent-box box-violet">
                        <span class="box-label">⏳ 승인 대기 중인 칭찬</span>
                        <div id="pendingPraiseList">
                            <div class="empty-state"><span class="empty-icon">💌</span>
                                <div class="empty-desc">대기 중인 칭찬이 없습니다</div>
                            </div>
                        </div>
                    </div>
                    <!-- 승인된 칭찬 전체 목록 -->
                    <div class="accent-box box-violet">
                        <span class="box-label">✅ 승인된 칭찬 목록</span>
                        <div id="approvedPraiseList">
                            <div class="empty-state"><span class="empty-icon">📬</span>
                                <div class="empty-desc">승인된 칭찬이 없습니다</div>
                            </div>
                        </div>
                    </div>
                    </div>
                    <div id="teacherLetterManagePanel" class="hidden">
                    <!-- 학생 메시지 (배움노트에서 이전) -->
                    <div class="accent-box box-teal">
                        <span class="box-label">💬 학생 메시지</span>
                        <div style="margin-bottom:15px; padding:10px 0;">
                            <label style="display:block; margin-bottom:8px; font-family:'Jua', sans-serif;">📅 조회
                                날짜</label>
                            <input type="date" id="messageViewDate" class="class-tone-input"
                                style="width:100%; font-family:'Jua', sans-serif !important; font-size:1.05rem;"
                                onchange="loadTeacherMessages()">
                        </div>
                        <div id="messageList" style="max-height:400px; overflow-y:auto;">
                            <div class="empty-state">
                                <span class="empty-icon">💌</span>
                                <div class="empty-title">메시지가 없습니다</div>
                                <div class="empty-desc">날짜를 선택하면<br>학생들의 메시지를 볼 수 있습니다.</div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div id="criteriaMiniTab" class="hidden">
                    <div class="accent-box box-teal">
                        <span class="box-label">📅 날짜별 기준 설정</span>
                        <div
                            style="background:rgba(255,255,255,0.5); padding:15px; border-radius:10px; border:1px solid var(--border);">
                            <label style="display:block; margin-bottom:8px; font-family:'Jua', sans-serif;">📅 설정할
                                날짜</label>
                            <input type="date" id="settingDate"
                                style="width:100%; font-family:'Jua', sans-serif !important; font-size:1.05rem; margin-bottom:15px;"
                                onchange="syncAllDates(this.value); loadCriteriaForEdit()">
                            <label>🎯 학습 목표</label><input type="text" id="settingObjective"
                                placeholder="예: 세계의 다양한 기후와 지형에 따른 사람들의 생활 모습을 조사할 수 있다.">
                            <label>📋 평가 과제</label><input type="text" id="settingTask"
                                placeholder="예: 자신이 선택한 나라의 생활 모습을 조사하여 여행 가이드북 만들어 발표하기">
                            <button type="button" onclick="saveBasicInfo(this)" class="save-basic-btn">💾 1단계: 학습목표
                                및
                                평가과제 저장하기</button>
                            <p style="font-size:0.8rem; color:var(--text-sub); margin-top:-15px; text-align:center;">
                                ⚠️
                                평가기준을 AI로 생성하려면 이 버튼을 먼저 눌러 저장해야 합니다.</p>
                        </div>
                        <hr style="border:0; border-top:2px dashed var(--border); margin:25px 0;">
                        <div class="criteria-mode-header"
                            style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:20px; margin-bottom:10px;">
                            <label style="margin:0; padding-bottom:5px;">📊 평가기준 설정 (2단계)</label>
                            <div class="mini-tab-container"
                                style="margin:0; padding:4px; max-width:280px; width:100%; display:flex; gap:5px;">
                                <button type="button" class="mini-tab-btn active-setting"
                                    onclick="switchCriteriaMode('auto')" id="autoModeBtn"
                                    style="flex:1; font-size:0.85rem; padding:8px 0;">✨ AI로 생성하기</button>
                                <button type="button" class="mini-tab-btn" onclick="switchCriteriaMode('manual')"
                                    id="manualModeBtn" style="flex:1; font-size:0.85rem; padding:8px 0;">✏️ 수동
                                    작성하기</button>
                            </div>
                        </div>
                        <div id="autoCriteriaArea">
                            <div
                                style="background:var(--bg-soft); padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid var(--border);">
                                <div style="display:flex; gap:10px; margin-bottom:10px;">
                                    <div style="flex:1;"><label style="font-size:0.8rem;">학교급</label><select
                                            id="autoSchoolLevel" style="margin-bottom:0;"
                                            onchange="updateGradeOptions()">
                                            <option value="초등학교" selected>초등학교</option>
                                            <option value="중학교">중학교</option>
                                            <option value="고등학교">고등학교</option>
                                        </select></div>
                                    <div style="flex:1;"><label style="font-size:0.8rem;">학년</label><select
                                            id="autoGradeSelect" style="margin-bottom:0;">
                                            <option value="1학년">1학년</option>
                                            <option value="2학년">2학년</option>
                                            <option value="3학년">3학년</option>
                                            <option value="4학년">4학년</option>
                                            <option value="5학년" selected>5학년</option>
                                            <option value="6학년">6학년</option>
                                        </select></div>
                                    <div style="flex:1;"><label style="font-size:0.8rem;">평가 대상</label><select
                                            id="autoTargetSelect" style="margin-bottom:0;">
                                            <option value="individual">개인 평가</option>
                                            <option value="group">모둠 평가</option>
                                        </select></div>
                                </div>
                                <button type="button" onclick="generateCriteriaAI(this)"
                                    style="background:linear-gradient(135deg, #9575CD 0%, #7E57C2 100%); width:100%;">🤖
                                    2단계: AI로 기준 자동 생성하기</button>
                            </div>
                            <div id="autoResultInputs">
                                <div style="margin-bottom:12px;"><label
                                        style="font-size:0.85rem; color:var(--color-blue);">① 지식・이해</label><input
                                        type="text" id="autoRate1" placeholder="AI 결과 1" style="margin-bottom:5px;"
                                        readonly disabled><input type="text" id="autoRate2" placeholder="AI 결과 2"
                                        style="margin-bottom:0;" readonly disabled></div>
                                <div style="margin-bottom:12px;"><label
                                        style="font-size:0.85rem; color:var(--color-teal);">② 과정・기능</label><input
                                        type="text" id="autoRate3" placeholder="AI 결과 3" style="margin-bottom:5px;"
                                        readonly disabled><input type="text" id="autoRate4" placeholder="AI 결과 4"
                                        style="margin-bottom:0;" readonly disabled></div>
                                <div style="margin-bottom:12px;"><label
                                        style="font-size:0.85rem; color:var(--color-teacher);">③ 가치・태도</label><input
                                        type="text" id="autoRate5" placeholder="AI 결과 5" style="margin-bottom:5px;"
                                        readonly disabled><input type="text" id="autoRate6" placeholder="AI 결과 6"
                                        style="margin-bottom:0;" readonly disabled></div>
                            </div>
                        </div>
                        <div id="manualCriteriaArea" class="hidden">
                            <div style="margin-bottom:15px;">
                                <div
                                    style="font-weight:700; color:var(--color-blue); font-size:0.9rem; margin-bottom:8px;">
                                    ① 지식・이해</div><input type="text" id="settingRate1" placeholder="기준 1"
                                    style="margin-bottom:8px;"><input type="text" id="settingRate2" placeholder="기준 2"
                                    style="margin-bottom:0;">
                            </div>
                            <div style="margin-bottom:15px;">
                                <div
                                    style="font-weight:700; color:var(--color-teal); font-size:0.9rem; margin-bottom:8px;">
                                    ② 과정・기능</div><input type="text" id="settingRate3" placeholder="기준 1"
                                    style="margin-bottom:8px;"><input type="text" id="settingRate4" placeholder="기준 2"
                                    style="margin-bottom:0;">
                            </div>
                            <div style="margin-bottom:15px;">
                                <div
                                    style="font-weight:700; color:var(--color-teacher); font-size:0.9rem; margin-bottom:8px;">
                                    ③ 가치・태도</div><input type="text" id="settingRate5" placeholder="기준 1"
                                    style="margin-bottom:8px;"><input type="text" id="settingRate6" placeholder="기준 2"
                                    style="margin-bottom:0;">
                            </div>
                        </div>
                        <button onclick="saveDailyCriteria(this)"
                            style="background:var(--color-teal); margin-top:20px;">💾
                            3단계: 평가기준 저장하기</button>
                    </div>
                </div>
                <div id="settingsMiniTab" class="hidden">
                    <div id="classInfoCard" class="accent-box box-amber class-tone-section">
                        <span class="box-label">📋 우리 학급 정보</span>
                        <div class="settings-two-col" style="display:flex; gap:15px; margin-bottom:15px;">
                            <div class="settings-field" style="flex:1;"><label>학급명</label><input type="text" id="settingClassName" class="class-tone-input"
                                    placeholder="예: 부평서초6-1" style="font-family:'Jua', sans-serif !important;">
                            </div>
                            <div class="settings-field" style="flex:1;"><label>클래스 코드</label><input type="text" id="settingClassCode" class="class-tone-input"
                                    placeholder="예: 부평서초34" style="font-family:'Jua', sans-serif !important;"></div>
                        </div>
                        <button onclick="saveClassInfo(this)" style="background:var(--color-result);">💾 학급 정보
                            저장하기</button>
                        <p style="font-size:0.8rem; color:var(--text-sub); margin-top:10px; text-align:center;">※
                            클래스 코드를 변경하면 학생들도 새로운 코드로 접속해야 합니다. (띄어쓰기 금지)</p>
                    </div>
                    <div id="classCompositionCard" class="accent-box box-violet class-tone-section">
                        <span class="box-label">🏫 우리 반 구성 설정</span>
                        <div id="classCompositionFields" class="settings-two-col" style="display:flex; gap:15px; margin-bottom:15px;">
                            <div class="settings-field" style="flex:1;"><label>👤 학생 수</label><input type="number" id="settingStudentCount" class="class-tone-input"
                                    min="1" max="50" placeholder="30" style="font-family:'Jua', sans-serif !important;">
                            </div>
                            <div class="settings-field" style="flex:1;"><label>👥 모둠 수</label><input type="number" id="settingGroupCount" class="class-tone-input"
                                    min="1" max="20" placeholder="6" style="font-family:'Jua', sans-serif !important;">
                            </div>
                        </div>
                        <button onclick="saveClassSettingsUI(this)" style="background:var(--color-teacher);">💾 반 구성
                            저장하기</button>
                        <p style="font-size:0.8rem; color:var(--text-sub); margin-top:10px; text-align:center;">※
                            학생 수와 모둠 수를 설정합니다.</p>
                    </div>
                    <div class="accent-box box-blue class-tone-section">
                        <span class="box-label">👥 학생 번호 매핑 현황</span>
                        <p style="font-size:0.82rem; color:var(--text-sub); margin-bottom:12px;">
                            각 번호에 등록된 Google 계정을 확인하고, 필요시 등록을 해제할 수 있습니다.
                        </p>
                        <div id="studentMappingGrid" class="student-manage-grid"></div>
                    </div>
                    <div class="accent-box box-red">
                        <span class="box-label" style="color:var(--color-danger);">⚠️ 데이터 초기화</span>
                        <p style="color:var(--color-danger); font-size:0.9rem; margin-bottom:15px;">
                            <strong>주의:</strong>
                            모든 학급 내 데이터가 삭제됩니다.
                        </p>
                        <button id="resetBtn" onclick="resetAllReviewData(this)">학급 데이터 전체 초기화</button>
                    </div>
                    <div id="settingMsg" class="message"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="customModal" class="modal-overlay hidden">
        <div class="modal-box">
            <span id="modalIcon" class="modal-icon">🤔</span>
            <div id="modalTitle" class="modal-title">알림</div>
            <div id="modalMessage" class="modal-text"></div>
            <input type="text" id="modalInput" class="hidden"
                style="width:100%; box-sizing:border-box; padding:12px; margin-bottom:20px; border:2px solid var(--border); border-radius:10px; font-size:1rem; outline:none;">
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="modalCancelBtn">취소</button>
                <button class="modal-btn confirm" id="modalConfirmBtn">확인</button>
            </div>
        </div>
    </div>
    <!-- 교과세특 엑셀 다운로드 모달 -->
    <div id="teacherSubjectCommentExportModal" class="modal-overlay hidden">
        <div class="modal-box" style="max-width:520px;">
            <span class="modal-icon">📊</span>
            <div class="modal-title">교과세특(.xlsx) 다운로드</div>
            <div class="modal-text" style="text-align:left;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px;">
                    <div>
                        <label style="font-size:0.8rem;">학기</label>
                        <select id="teacherSubjectCommentExportSemester" class="class-tone-input" style="margin-bottom:0;">
                            <option value="all" selected>전체</option>
                            <option value="1">1학기</option>
                            <option value="2">2학기</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.8rem;">과목</label>
                        <select id="teacherSubjectCommentExportSubject" class="class-tone-input" style="margin-bottom:0;">
                            <option value="all" selected>전체</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.8rem;">대상</label>
                        <select id="teacherSubjectCommentExportTarget" class="class-tone-input" style="margin-bottom:0;">
                            <option value="all" selected>전체 학생</option>
                            <option value="selected">선택 학생</option>
                            <option value="current">현재 학생</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.8rem;">학교급</label>
                        <select id="teacherSubjectCommentExportSchoolLevel" class="class-tone-input" style="margin-bottom:0;">
                            <option value="">(설정 사용)</option>
                            <option value="초">초</option>
                            <option value="중">중</option>
                            <option value="고">고</option>
                        </select>
                    </div>
                </div>

                <div id="teacherSubjectCommentExportSelectedArea" class="hidden" style="margin-top:12px;">
                    <div style="font-size:0.8rem; margin-bottom:8px; color:var(--text-sub);">선택 학생(번호)</div>
                    <div id="teacherSubjectCommentExportStudentGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(78px, 1fr)); gap:8px;"></div>
                </div>

                <div id="teacherSubjectCommentExportMsg" class="message" style="display:none; margin-top:12px;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" type="button" onclick="closeTeacherSubjectCommentExportModal()">취소</button>
                <button class="modal-btn confirm" type="button" onclick="downloadTeacherSubjectCommentXlsx()">다운로드</button>
            </div>
        </div>
    </div>

    <!-- SheetJS (xlsx) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="app.js?v=20260215-subject-comment-1"></script>
</body>

</html>


